Spring Cloud CircuitBreaker GatewayFilter 工厂使用Spring Cloud CircuitBreaker API 将 Gateway 路由包裹在一个熔断器中。Spring Cloud CircuitBreaker 支持多个可与 Spring Cloud Gateway 一起使用的库。Spring Cloud 支持 Resilience4J 开箱即用。

要启用 Spring Cloud CircuitBreaker 过滤器，你需要添加 spring-cloud-starter-circuitbreaker-reactor-resilience4j 依赖。下面的例子配置了一个 Spring Cloud CircuitBreaker GatewayFilter。

_Example 22. application.yml_



```plain
spring:
  cloud:
    gateway:
      routes:
      - id: circuitbreaker_route
        uri: https://example.org
        filters:
        - CircuitBreaker=myCircuitBreaker
```



要配置熔断器，请参阅你所使用的底层熔断器实现的配置。

+ [Resilience4J 文档](https://cloud.spring.io/spring-cloud-circuitbreaker/reference/html/spring-cloud-circuitbreaker.html)

Spring Cloud CircuitBreaker 过滤器还可以接受一个可选的 fallbackUri 参数。目前，只支持 forward: 模式的URI。如果fallback被调用，请求将被转发到URI所匹配的控制器。下面的例子配置了这样一个fallback。

_Example 23. application.yml_



```plain
spring:
  cloud:
    gateway:
      routes:
      - id: circuitbreaker_route
        uri: lb://backing-service:8088
        predicates:
        - Path=/consumingServiceEndpoint
        filters:
        - name: CircuitBreaker
          args:
            name: myCircuitBreaker
            fallbackUri: forward:/inCaseOfFailureUseThis
        - RewritePath=/consumingServiceEndpoint, /backingServiceEndpoint
```



也可以通过Java来实现相同的配置，如下。

_Example 24. Application.java_



```plain
@Bean
public RouteLocator routes(RouteLocatorBuilder builder) {
    return builder.routes()
        .route("circuitbreaker_route", r -> r.path("/consumingServiceEndpoint")
            .filters(f -> f.circuitBreaker(c -> c.name("myCircuitBreaker").fallbackUri("forward:/inCaseOfFailureUseThis"))
                .rewritePath("/consumingServiceEndpoint", "/backingServiceEndpoint")).uri("lb://backing-service:8088")
        .build();
}
```



当熔断器 fallback 被调用时，这个例子转发到 /inCaseofFailureUseThis URI。请注意，这个例子还演示了（可选）Spring Cloud LoadBalancer 的负载均衡（由目标URI上的 lb 前缀定义）。

CircuitBreaker 还支持 fallbackUri 中的URI变量。这允许更复杂的路由选项，比如使用 [PathPattern 表达式](https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/util/pattern/PathPattern.html) 转发原始主机或URL路径的部分。

在下面的例子中，调用 consumingServiceEndpoint/users/1 将被重定向到 inCaseOfFailureUseThis/users/1。

_Example 25. application.yml_



```plain
spring:
  cloud:
    gateway:
      routes:
      - id: circuitbreaker_route
        uri: lb://backing-service:8088
        predicates:
        - Path=/consumingServiceEndpoint/{*segments}
        filters:
        - name: CircuitBreaker
          args:
            name: myCircuitBreaker
            fallbackUri: forward:/inCaseOfFailureUseThis/{segments}
```



一般情况下是使用 fallbackUri 来定义网关应用程序中的内部controller或handler。然而，你也可以将请求重新路由到外部应用程序的controller或handler，如下所示。

_Example 26. application.yml_



```plain
spring:
  cloud:
    gateway:
      routes:
      - id: ingredients
        uri: lb://ingredients
        predicates:
        - Path=//ingredients/**
        filters:
        - name: CircuitBreaker
          args:
            name: fetchIngredients
            fallbackUri: forward:/fallback
      - id: ingredients-fallback
        uri: http://localhost:9994
        predicates:
        - Path=/fallback
```



在这个例子中，网关应用程序中没有 fallback 端点或处理程序。然而，在另一个应用程序中有一个，在 [localhost:9994](http://localhost:9994/)下注册。

在请求被转发到 fallback 的情况下，Spring Cloud CircuitBreaker Gateway 过滤器也提供了造成这种情况的 Throwable。它作为 ServerWebExchangeUtils.CIRCUITBREAKER_EXECUTION_EXCEPTION_ATTR 属性被添加到 ServerWebExchange中，在网关应用中处理 fallback 时可以使用。

对于外部 controller/handler 的情况，可以添加带有异常细节的header。你可以在[FallbackHeaders GatewayFilter Factory 部分](https://springdoc.cn/spring-cloud-gateway/#fallback-headers)找到更多关于这样做的信息。

