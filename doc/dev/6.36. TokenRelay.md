Token Relay是指OAuth2消费者作为客户端，将传入的令牌转发给传出的资源请求。消费者可以是一个纯粹的客户端（如SSO应用程序）或一个资源服务器。

Spring Cloud Gateway 可以将 OAuth2 访问令牌转发到它所代理的服务的下游。为了在网关中添加这一功能，你需要像这样添加 TokenRelayGatewayFilterFactory。

_App.java_

```plain
@Bean
public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
    return builder.routes()
            .route("resource", r -> r.path("/resource")
                    .filters(f -> f.tokenRelay())
                    .uri("http://localhost:9000"))
            .build();
}
```



或者，这样。

_application.yaml_

```plain
spring:
  cloud:
    gateway:
      routes:
      - id: resource
        uri: http://localhost:9000
        predicates:
        - Path=/resource
        filters:
        - TokenRelay=
```



它将（除了登录用户和抓取令牌之外）把认证令牌传递给下游的服务（在这里是 /resource）。

要为 Spring Cloud Gateway 启用这个功能，需要添加以下依赖

+ org.springframework.boot:spring-boot-starter-oauth2-client

它是如何工作的？ {githubmaster}/src/main/java/org/springframework/cloud/gateway/security/TokenRelayGatewayFilterFactory.java[filter]从当前认证的用户中提取一个访问令牌，并将其放在下游请求的请求头中。

完整的工作样本见 [该项目](https://github.com/spring-cloud-samples/sample-gateway-oauth2login)。

| 只有当适当的 spring.security.oauth2.client.* 属性被设置时， TokenRelayGatewayFilterFactory Bean才会被创建，这将触发 ReactiveClientRegistrationRepository Bean的创建。 |
| --- |


| TokenRelayGatewayFilterFactory 使用的 ReactiveOAuth2AuthorizedClientService 的默认实现使用了一个内存数据存储。如果你需要一个更强大的解决方案，你将需要提供你自己的实现 ReactiveOAuth2AuthorizedClientService。 |
| --- |






  


