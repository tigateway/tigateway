默认情况下，RemoteAddr路由谓语工厂使用传入请求中的远程地址。如果Spring Cloud Gateway位于代理层后面，这可能与实际的客户IP地址不一致。

你可以通过设置一个自定义的 RemoteAddressResolver 来定制远程地址的解析方式。Spring Cloud Gateway有一个非默认的远程地址解析器，它是基于 [X-Forwarded-For Header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For)的，即 XForwardedRemoteAddressResolver。

XForwardedRemoteAddressResolver 有两个静态构造方法，它们对安全问题采取了不同的方法。

+ XForwardedRemoteAddressResolver::trustAll 返回一个 RemoteAddressResolver，它总是采用 X-Forwarded-For 头中发现的第一个IP地址。这种方法容易受到欺骗，因为恶意的客户端可以为 X-Forwarded-For 设置一个初始值，这将被解析器所接受。
+ XForwardedRemoteAddressResolver::maxTrustedIndex 需要一个索引，该索引与在 Spring Cloud Gateway 前面运行的可信基础设施的数量相关。例如，如果 Spring Cloud Gateway 只能通过 HAProxy 访问，那么应使用1的值。如果在Spring Cloud Gateway被访问之前需要经过2个受信任的基础设施，那么应该使用2的值。

请考虑以下 header 值。

```plain
X-Forwarded-For: 0.0.0.1, 0.0.0.2, 0.0.0.3
```



以下的 maxTrustedIndex 值产生以下的远程地址。

| maxTrustedIndex | 结果 |
| :--- | :--- |
| [Integer.MIN_VALUE,0] | (无效, 初始化时会抛出 IllegalArgumentException 异常) |
| 1 | 0.0.0.3 |
| 2 | 0.0.0.2 |
| 3 | 0.0.0.1 |
| [4, Integer.MAX_VALUE] | 0.0.0.1 |


下面的例子显示了如何用Java实现同样的配置。

_Example 11. GatewayConfig.java_

```plain
RemoteAddressResolver resolver = XForwardedRemoteAddressResolver
    .maxTrustedIndex(1);

...

.route("direct-route",
    r -> r.remoteAddr("10.1.1.1", "10.10.1.1/24")
        .uri("https://downstream1")
.route("proxied-route",
    r -> r.remoteAddr(resolver, "10.10.1.1", "10.10.1.1/24")
        .uri("https://downstream2")
)
```



  


